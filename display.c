//����:��LCD1602��ʾ xingxiangrong
//���뻷��: KEIL UVISION2
//��Ƭ������12M  ��Ƭ���ͺ�AT89S52
//��Ƭ������: ������Ҫ��
//���ߣ������ٵ���Ԫ����
//���ڣ�2013.07.02
//:ר����Ʒ���Ͻ�������ҵ��;��

#include <mcs51/at89x52.h>

#include "display.h"
#include "delay.h"

//==============LCD1602�ӿ����ӷ���=====================
/*-----------------------------------------------------
       |DB0-----P0.0 | DB4-----P0.4 | RW-------P2.3    |
       |DB1-----P0.1 | DB5-----P0.5 | RS-------P2.4    |
       |DB2-----P0.2 | DB6-----P0.6 | E--------P2.2    |
       |DB3-----P0.3 | DB7-----P0.7 | 
    ---------------------------------------------------*/
//================================================*/              
#define LCM_Data     P0    //LCD1602���ݽӿ�
#define Busy         0x80   //���ڼ��LCM״̬���е�Busy��ʶ
__sbit __at (0xA3) LCM_RW;  //��д��������ˣ�LCD1602�ĵ����
__sbit __at (0xA4) LCM_RS;  //�Ĵ���ѡ������ˣ�LCD1602�ĵ��Ľ�
__sbit __at (0xA2) LCM_E;  //ʹ���ź������,LCD1602�ĵ�6��


/*====================================================================  
  ��ָ��λ����ʾһ���ַ�:�� X ��,�� y��
  ע��:�ַ������ܳ���16���ַ�
======================================================================*/
void DisplayListChar(uchar X,uchar Y,uchar ms, __code const uchar *DData)
{
 unsigned char ListLength;

 ListLength = 0;

 X &= 0x1;
 Y &= 0xF; //����X���ܴ���15��Y���ܴ���1
 while (DData[ListLength]!='\0') //����ִ�β���˳�
  { 
     if (Y <= 0xF) //X����ӦС��0xF
     {
        DisplayOneChar(X, Y, DData[ListLength]); //��ʾ�����ַ�
        ListLength++;
        Y++;
	    delayms(ms);//��ʱ��ʾ�ַ���
     }
     else
	    break;//����ѭ���� 
  }
}
/*======================================================================
 LCM��ʼ��
======================================================================*/
void LCMInit(void) 
{
 LCM_Data = 0;
 WriteCommandLCM(0x38,0); //������ʾģʽ���ã������æ�ź�
 delayms(5);
 WriteCommandLCM(0x38,0);
 delayms(5);
 WriteCommandLCM(0x38,0);
 delayms(5);
 WriteCommandLCM(0x38,1); //��ʾģʽ����,��ʼҪ��ÿ�μ��æ�ź�
 WriteCommandLCM(0x08,1); //�ر���ʾ
 WriteCommandLCM(0x01,1); //��ʾ����
 WriteCommandLCM(0x06,1); // ��ʾ����ƶ�����
 WriteCommandLCM(0x0C,1); // ��ʾ�����������
 delayms(100);
}
//==============================LCD1602��ʾ�ӳ���================================================
// д���ݺ���: E =������ RS=1 RW=0
//======================================================================*/
void WriteDataLCM(uchar WDLCM)
{
 ReadStatusLCM(); //���æ
 LCM_Data = WDLCM;
 LCM_RS = 1;
 LCM_RW = 0;
 LCM_E = 0; //�����ٶ�̫�߿���������С����ʱ
 LCM_E = 0; //��ʱ
 LCM_E = 1;
}
/*====================================================================
  дָ���: E=������ RS=0 RW=0
======================================================================*/
void WriteCommandLCM(uchar WCLCM, int BuysC) //BuysCΪ0ʱ����æ���
{
 if (BuysC) ReadStatusLCM(); //������Ҫ���æ
 LCM_Data = WCLCM;
 LCM_RS = 0;
 LCM_RW = 0;
 LCM_E = 0;
 LCM_E = 0;
 LCM_E = 1;
}
/*====================================================================
  ������д����֮ǰ������LCD������״̬:E=1 RS=0 RW=1;
  DB7: 0 LCD���������У�1 LCD������æ��
  ��״̬
======================================================================*/
uchar ReadStatusLCM(void)
{
 LCM_Data = 0xFF;
 LCM_RS = 0;
 LCM_RW = 1;
 LCM_E = 0;
 LCM_E = 0;
 LCM_E = 1;
 while (LCM_Data & Busy); //���æ�ź�  
 return(LCM_Data);
}
/*======================================================================
�� ��:     ��1602 ָ��λ����ʾһ���ַ�:��һ��λ��0~15,�ڶ���16~31
˵ ��:     �� X ��,�� y ��  ע��:�ַ������ܳ���16���ַ�
======================================================================*/
void DisplayOneChar( uchar X, uchar Y, uchar ASCII)
{
  X &= 0x1;
  Y &= 0xF; //����Y���ܴ���15��X���ܴ���1
  if (X) Y |= 0x40; //��Ҫ��ʾ�ڶ���ʱ��ַ��+0x40;
  Y |= 0x80; // ���ָ����
  WriteCommandLCM(Y, 0); //���ﲻ���æ�źţ����͵�ַ��
  WriteDataLCM(ASCII);
}

void ClearLine(uchar row)
{
	unsigned char col;
	
	for (col = 0; col < 16; ++col)
	{
        DisplayOneChar(row, col, ' ');
	}
}
		
void ClearScreen()
{
	ClearLine(0);
	ClearLine(1);
}
